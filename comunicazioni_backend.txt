📋 **DOCUMENTAZIONE BACKEND - SISTEMA RISK MANAGEMENT**
*Versione 2.0 - Aggiornamento Completo*

---

## 🎯 ARCHITETTURA DEL SISTEMA

**Backend Engine:** Server Python su porta 8000
**Frontend:** Applicazione su porta 5173
**Database:** File JSON con mappature Excel (191 eventi totali)

---

## 📊 ENDPOINT DISPONIBILI

### ✅ **1. GET /categories**
**Descrizione:** Ottiene tutte le categorie di rischio disponibili
**Response:**
```json
{
  "categories": [
    "Damage_Danni",
    "Business_disruption",
    "Employment_practices_Dipendenti",
    "Execution_delivery_Problemi_di_produzione_o_consegna",
    "Clients_product_Clienti",
    "Internal_Fraud_Frodi_interne",
    "External_fraud_Frodi_esterne"
  ],
  "total": 7
}
```

### ✅ **2. GET /events/{category}**
**Descrizione:** Ottiene tutti gli eventi per una categoria specifica
**Parametri:** 
- `category`: Nome esatto della categoria (es: "Damage_Danni")

**Response esempio per Damage_Danni:**
```json
{
  "category": "Damage_Danni",
  "events": [
    {"code": "101", "name": "Natural disasters", "severity": "high"},
    {"code": "102", "name": "Water damage", "severity": "medium"},
    // ... altri eventi
  ],
  "total": 10
}
```

**Distribuzione eventi per categoria:**
- Damage_Danni: 10 eventi (codici 101-115)
- Business_disruption: 20 eventi (codici 201-299)
- Employment_practices_Dipendenti: 22 eventi (codici 301-399)
- Execution_delivery_Problemi_di_produzione_o_consegna: 59 eventi (codici 401-499)
- Clients_product_Clienti: 44 eventi (codici 501-599)
- Internal_Fraud_Frodi_interne: 20 eventi (codici 601-699)
- External_fraud_Frodi_esterne: 16 eventi (codici 701-799)

### ✅ **3. GET /description/{event_code}**
**Descrizione:** Ottiene la descrizione dettagliata di un evento (formula VLOOKUP dall'Excel)
**Parametri:**
- `event_code`: Codice numerico dell'evento come stringa (es: "102", "505")

**Response:**
```json
{
  "event_code": "102",
  "description": "Danni dovuti a forti piogge, allagamenti, fiumi, tempeste, venti forti, grandinate, inondazioni, tornado, uragani e altre calamità naturali di origine idrologica"
}
```

### ✅ **4. GET /risk-assessment-fields** 
**Descrizione:** Fornisce la struttura completa dei 5 campi di valutazione "Perdita Finanziaria Attesa"
**Response:**
```json
{
  "fields": [
    {
      "id": "impatto_finanziario",
      "column": "H",
      "question": "Qual è l'impatto finanziario stimato?",
      "type": "select",
      "options": ["N/A", "0 - 1K€", "1 - 10K€", "10 - 50K€", "50 - 100K€", "100 - 500K€", "500K€ - 1M€", "1 - 3M€", "3 - 5M€"],
      "required": true
    },
    {
      "id": "perdita_economica",
      "column": "I",
      "question": "Qual è il livello di perdita economica attesa?",
      "type": "select_color",
      "options": [
        {"value": "G", "label": "Bassa/Nulla", "color": "green", "emoji": "🟢"},
        {"value": "Y", "label": "Media", "color": "yellow", "emoji": "🟡"},
        {"value": "O", "label": "Importante", "color": "orange", "emoji": "🟠"},
        {"value": "R", "label": "Grave", "color": "red", "emoji": "🔴"}
      ],
      "required": true
    },
    {
      "id": "impatto_immagine",
      "column": "J",
      "question": "L'evento ha impatto sull'immagine aziendale?",
      "type": "boolean",
      "options": ["Si", "No"],
      "required": true
    },
    {
      "id": "impatto_regolamentare",
      "column": "L",
      "question": "Ci sono possibili conseguenze regolamentari o legali civili?",
      "type": "boolean",
      "options": ["Si", "No"],
      "description": "Multe, sanzioni amministrative, cause civili",
      "required": true
    },
    {
      "id": "impatto_criminale",
      "column": "M",
      "question": "Ci sono possibili conseguenze penali?",
      "type": "boolean",
      "options": ["Si", "No"],
      "description": "Denunce penali, procedimenti criminali",
      "required": true
    }
  ]
}
```

### ✅ **5. POST /save-risk-assessment**
**Descrizione:** Salva la valutazione del rischio e calcola il risk score
**Headers:** `Content-Type: application/json`
**Body richiesto:**
```json
{
  "event_code": "505",
  "category": "Clients_product_Clienti",
  "impatto_finanziario": "10 - 50K€",
  "perdita_economica": "O",
  "impatto_immagine": "Si",
  "impatto_regolamentare": "No",
  "impatto_criminale": "No"
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Risk assessment salvato",
  "risk_score": 45,
  "analysis": "Livello di rischio: MEDIO (Score: 45/100). Monitorare e valutare opzioni"
}
```

**Calcolo Risk Score:**
- Impatto finanziario: max 40 punti
- Perdita economica: max 30 punti  
- Impatto immagine: 10 punti se "Si"
- Impatto regolamentare: 10 punti se "Si"
- Impatto criminale: 10 punti se "Si"
- **Totale massimo: 100 punti**

**Livelli di rischio:**
- CRITICO: ≥70 punti → Azione immediata
- ALTO: 50-69 punti → Priorità alta
- MEDIO: 30-49 punti → Monitoraggio
- BASSO: <30 punti → Rischio accettabile

### ✅ **6. GET /stats**
**Descrizione:** Statistiche complete del sistema
**Response:**
```json
{
  "total_categories": 7,
  "total_events": 191,
  "total_descriptions": 187,
  "events_per_category": {
    "Damage_Danni": 10,
    "Business_disruption": 20,
    // ... etc
  }
}
```

---

## 🔄 FLUSSO OPERATIVO COMPLETO

### **Fase 1: Selezione Evento**
1. Frontend chiama `GET /categories` per mostrare le 7 categorie
2. Utente seleziona una categoria
3. Frontend chiama `GET /events/{category}` per mostrare gli eventi
4. Utente seleziona un evento specifico
5. Frontend chiama `GET /description/{event_code}` per mostrare la descrizione

### **Fase 2: Valutazione Rischio (NUOVO)**
6. Frontend chiama `GET /risk-assessment-fields` per ottenere i 5 campi
7. Frontend mostra il form con le 5 domande sequenziali
8. Utente compila tutti i campi
9. Frontend invia `POST /save-risk-assessment` con tutti i dati
10. Backend calcola risk score e ritorna l'analisi

---

## ⚠️ NOTE TECNICHE IMPORTANTI

### **Formato Dati:**
- **Codici evento:** Sempre come stringa ("102", non 102)
- **Perdita economica:** Inviare solo la lettera (G, Y, O, R)
- **Campi Si/No:** Esattamente "Si" o "No" con S maiuscola
- **Impatto finanziario:** Valore esatto dalla lista opzioni

### **URL Base:**
- **Sviluppo locale:** `http://localhost:8000`
- **Produzione:** `https://ateco-lookup.onrender.com`

### **CORS:**
- Tutti gli endpoint supportano CORS
- Header `Access-Control-Allow-Origin: *` già configurato

### **Encoding:**
- Tutte le risposte in UTF-8
- Supporto completo caratteri italiani e emoji

---

## 📈 PROSSIMI SVILUPPI

**Prossime colonne Excel da implementare:**
- Colonna N: Frequenza dell'evento
- Colonna O: Controlli esistenti
- Colonna P: Efficacia controlli
- Colonna Q: Risk appetite
- Ulteriori colonne secondo necessità cliente

---

## 💡 SUPPORTO TECNICO

Per qualsiasi problema o chiarimento, il backend è completamente operativo e testato.
Tutti gli endpoint sono pronti per produzione.

**Sistema sviluppato seguendo fedelmente la logica Excel originale.**
**191 eventi mappati con precisione dalle formule VLOOKUP.**

---

*Backend Engine v2.0 - Sistema Risk Management Professionale*