# üìã STATO PROGETTO ATECO-LOOKUP - ESTRAZIONE VISURE

## üéØ OBIETTIVO
Implementare endpoint `/api/extract-visura` per estrarre dati da PDF di visure camerali.

## ‚ùå PROBLEMA RISOLTO
**Errore 500 su endpoint `/api/extract-visura`**:
- **Causa principale**: Il logger veniva usato prima di essere definito (righe 57-63 in ateco_lookup.py)
- **Causa secondaria**: Mancavano dipendenze essenziali per pdfplumber
- **Causa terziaria**: Non c'era un sistema di fallback se pdfplumber falliva

## ‚úÖ COSA ABBIAMO FATTO (SOLUZIONI IMPLEMENTATE)

### 1. **Fix ordine import e logging** (ateco_lookup.py):
   - Spostato import VisuraExtractor DOPO la configurazione del logger
   - Aggiunto try/except con logging appropriato per gestire import falliti
   - Implementato caricamento dinamico di VisuraExtractor se non disponibile all'avvio

### 2. **Implementato sistema di fallback robusto** (visura_extractor.py):
   - Sistema automatico di fallback: pdfplumber ‚Üí PyPDF2
   - Se pdfplumber non √® disponibile, usa automaticamente PyPDF2
   - Gestione errori pagina per pagina per massima resilienza
   - Log dettagliato del metodo di estrazione utilizzato

### 3. **Aggiunte dipendenze mancanti** (requirements.txt):
   ```
   pdfplumber
   PyPDF2
   Pillow>=9.0.0
   pdfminer.six>=20211012
   ```

### 4. **Migliorato error handling**:
   - Messaggi di errore pi√π chiari e actionable
   - Logging dettagliato a ogni step critico
   - Traceback completo in modalit√† debug
   - Response JSON strutturate con codici errore specifici

## üöÄ STATO ATTUALE
- **File modificati**:
  - `ateco_lookup.py`: Fix import order e error handling migliorato
  - `visura_extractor.py`: Completamente riscritto con fallback PyPDF2
  - `requirements.txt`: Aggiunte tutte le dipendenze necessarie

- **Sistema ora supporta**:
  1. Estrazione con pdfplumber (pi√π accurato)
  2. Fallback automatico a PyPDF2 se pdfplumber fallisce
  3. Gestione errori robusta con log dettagliati
  4. Compatibilit√† massima con diversi ambienti di deployment

## üìà PROSSIMI PASSI
1. **Committare e pushare le modifiche** su GitHub
2. **Deploy su Render** per testare in produzione
3. **Verificare i log** per confermare che l'import funziona
4. **Testare l'endpoint** con un PDF di visura reale

## üí° NOTE TECNICHE
Il sistema ora ha una struttura di fallback a 3 livelli:
- **Livello 1**: Prova pdfplumber (pi√π accurato per PDF complessi)
- **Livello 2**: Se fallisce, usa PyPDF2 (pi√π leggero e compatibile)
- **Livello 3**: Se entrambi falliscono, ritorna errore chiaro con istruzioni

## üîß COMANDI PER DEPLOY
```bash
# Commit delle modifiche
git add -A
git commit -m "fix: risolto definitivamente errore 500 su /api/extract-visura"
git push origin main

# Il deploy su Render avverr√† automaticamente
```

## ‚ú® RISULTATO ATTESO
Dopo il deploy, l'endpoint `/api/extract-visura` dovrebbe:
1. Accettare upload di PDF di visure camerali
2. Estrarre codici ATECO, oggetto sociale, sedi
3. Inferire tipo di business (B2B/B2C)
4. Arricchire i dati con informazioni dal database ATECO
5. Ritornare JSON strutturato con tutti i dati estratti

(index):1 Access to fetch at 'https://ateco-lookup.onrender.com/api/extract-visura' from origin 'http://localhost:5173' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.Understand this error
useVisuraExtraction.ts:40  POST https://ateco-lookup.onrender.com/api/extract-visura net::ERR_FAILED 500 (Internal Server Error)
extractWithBackend @ useVisuraExtraction.ts:40
(anonymous) @ useVisuraExtraction.ts:191
(anonymous) @ useUpload.ts:70
(anonymous) @ useUpload.ts:56
handleDrop @ UploadCenter.tsx:29
callCallback2 @ chunk-PJEEZAML.js?v=1fb14d92:3674
invokeGuardedCallbackDev @ chunk-PJEEZAML.js?v=1fb14d92:3699
invokeGuardedCallback @ chunk-PJEEZAML.js?v=1fb14d92:3733
invokeGuardedCallbackAndCatchFirstError @ chunk-PJEEZAML.js?v=1fb14d92:3736
executeDispatch @ chunk-PJEEZAML.js?v=1fb14d92:7014
processDispatchQueueItemsInOrder @ chunk-PJEEZAML.js?v=1fb14d92:7034
processDispatchQueue @ chunk-PJEEZAML.js?v=1fb14d92:7043
dispatchEventsForPlugins @ chunk-PJEEZAML.js?v=1fb14d92:7051
(anonymous) @ chunk-PJEEZAML.js?v=1fb14d92:7174
batchedUpdates$1 @ chunk-PJEEZAML.js?v=1fb14d92:18913
batchedUpdates @ chunk-PJEEZAML.js?v=1fb14d92:3579
dispatchEventForPluginEventSystem @ chunk-PJEEZAML.js?v=1fb14d92:7173
dispatchEventWithEnableCapturePhaseSelectiveHydrationWithoutDiscreteEventReplay @ chunk-PJEEZAML.js?v=1fb14d92:5478
dispatchEvent @ chunk-PJEEZAML.js?v=1fb14d92:5472
dispatchDiscreteEvent @ chunk-PJEEZAML.js?v=1fb14d92:5449Understand this error
useVisuraExtraction.ts:61 ‚ùå Backend extraction failed: TypeError: Failed to fetch
    at extractWithBackend (useVisuraExtraction.ts:40:30)
    at useVisuraExtraction.ts:191:24
    at useUpload.ts:70:33
    at Array.forEach (<anonymous>)
    at useUpload.ts:56:16
    at handleDrop (UploadCenter.tsx:29:7)
    at HTMLUnknownElement.callCallback2 (chunk-PJEEZAML.js?v=1fb14d92:3674:22)
    at Object.invokeGuardedCallbackDev (chunk-PJEEZAML.js?v=1fb14d92:3699:24)
    at invokeGuardedCallback (chunk-PJEEZAML.js?v=1fb14d92:3733:39)
    at invokeGuardedCallbackAndCatchFirstError (chunk-PJEEZAML.js?v=1fb14d92:3736:33)
extractWithBackend @ useVisuraExtraction.ts:61
await in extractWithBackend
(anonymous) @ useVisuraExtraction.ts:191
(anonymous) @ useUpload.ts:70
(anonymous) @ useUpload.ts:56
handleDrop @ UploadCenter.tsx:29
callCallback2 @ chunk-PJEEZAML.js?v=1fb14d92:3674
invokeGuardedCallbackDev @ chunk-PJEEZAML.js?v=1fb14d92:3699
invokeGuardedCallback @ chunk-PJEEZAML.js?v=1fb14d92:3733
invokeGuardedCallbackAndCatchFirstError @ chunk-PJEEZAML.js?v=1fb14d92:3736
executeDispatch @ chunk-PJEEZAML.js?v=1fb14d92:7014
processDispatchQueueItemsInOrder @ chunk-PJEEZAML.js?v=1fb14d92:7034
processDispatchQueue @ chunk-PJEEZAML.js?v=1fb14d92:7043
dispatchEventsForPlugins @ chunk-PJEEZAML.js?v=1fb14d92:7051
(anonymous) @ chunk-PJEEZAML.js?v=1fb14d92:7174
batchedUpdates$1 @ chunk-PJEEZAML.js?v=1fb14d92:18913
batchedUpdates @ chunk-PJEEZAML.js?v=1fb14d92:3579
dispatchEventForPluginEventSystem @ chunk-PJEEZAML.js?v=1fb14d92:7173
dispatchEventWithEnableCapturePhaseSelectiveHydrationWithoutDiscreteEventReplay @ chunk-PJEEZAML.js?v=1fb14d92:5478
dispatchEvent @ chunk-PJEEZAML.js?v=1fb14d92:5472
dispatchDiscreteEvent @ chunk-PJEEZAML.js?v=1fb14d92:5449Understand this error
useVisuraExtraction.ts:71 ü§ñ Tentativo 2: AI per estrazione visura...
useVisuraExtraction.ts:129 ‚úÖ AI extraction successful! {codici_ateco: Array(1), oggetto_sociale: "LA SOCIETA' HA PER OGGETTO LO SVILUPPO, LA PRODUZI‚Ä¶ VIGENTI NORME IN MATERIA DI ATTIVITA' RISERVATE.", sedi: {‚Ä¶}, tipo_business: 'B2B/B2C'}
useVisuraExtraction.ts:34 üîß Tentativo 1: Backend Python per estrazione visura...
chunk-PJEEZAML.js?v=1fb14d92:521 Warning: Encountered two children with the same key, `2_2023-02-10 CELERYA VISURA ORD.pdf-1756503876147-131373`. Keys should be unique so that components maintain their identity across updates. Non-unique keys may cause children to be duplicated and/or omitted ‚Äî the behavior is unsupported and could change in a future version.
    at ul
    at div
    at div
    at UploadCenter (http://localhost:5173/src/components/sidebar/UploadCenter.tsx:26:44)
    at aside
    at Sidebar
    at div
    at main
    at div
    at App (http://localhost:5173/App.tsx:26:17)
printWarning @ chunk-PJEEZAML.js?v=1fb14d92:521
error @ chunk-PJEEZAML.js?v=1fb14d92:505
warnOnInvalidKey @ chunk-PJEEZAML.js?v=1fb14d92:10219
reconcileChildrenArray @ chunk-PJEEZAML.js?v=1fb14d92:10235
reconcileChildFibers2 @ chunk-PJEEZAML.js?v=1fb14d92:10559
reconcileChildren @ chunk-PJEEZAML.js?v=1fb14d92:14292
updateHostComponent @ chunk-PJEEZAML.js?v=1fb14d92:14807
beginWork @ chunk-PJEEZAML.js?v=1fb14d92:15935
beginWork$1 @ chunk-PJEEZAML.js?v=1fb14d92:19753
performUnitOfWork @ chunk-PJEEZAML.js?v=1fb14d92:19198
workLoopSync @ chunk-PJEEZAML.js?v=1fb14d92:19137
renderRootSync @ chunk-PJEEZAML.js?v=1fb14d92:19116
performSyncWorkOnRoot @ chunk-PJEEZAML.js?v=1fb14d92:18874
flushSyncCallbacks @ chunk-PJEEZAML.js?v=1fb14d92:9119
flushSync @ chunk-PJEEZAML.js?v=1fb14d92:18959
finishEventHandler @ chunk-PJEEZAML.js?v=1fb14d92:3569
batchedUpdates @ chunk-PJEEZAML.js?v=1fb14d92:3582
dispatchEventForPluginEventSystem @ chunk-PJEEZAML.js?v=1fb14d92:7173
dispatchEventWithEnableCapturePhaseSelectiveHydrationWithoutDiscreteEventReplay @ chunk-PJEEZAML.js?v=1fb14d92:5478
dispatchEvent @ chunk-PJEEZAML.js?v=1fb14d92:5472
dispatchDiscreteEvent @ chunk-PJEEZAML.js?v=1fb14d92:5449Understand this error
(index):1 Access to fetch at 'https://ateco-lookup.onrender.com/api/extract-visura' from origin 'http://localhost:5173' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.Understand this error
useVisuraExtraction.ts:40  POST https://ateco-lookup.onrender.com/api/extract-visura net::ERR_FAILED 500 (Internal Server Error)
extractWithBackend @ useVisuraExtraction.ts:40
(anonymous) @ useVisuraExtraction.ts:191
(anonymous) @ useUpload.ts:70
(anonymous) @ useUpload.ts:56
handleFileChange @ ChatInputBar.tsx:36
callCallback2 @ chunk-PJEEZAML.js?v=1fb14d92:3674
invokeGuardedCallbackDev @ chunk-PJEEZAML.js?v=1fb14d92:3699
invokeGuardedCallback @ chunk-PJEEZAML.js?v=1fb14d92:3733
invokeGuardedCallbackAndCatchFirstError @ chunk-PJEEZAML.js?v=1fb14d92:3736
executeDispatch @ chunk-PJEEZAML.js?v=1fb14d92:7014
processDispatchQueueItemsInOrder @ chunk-PJEEZAML.js?v=1fb14d92:7034
processDispatchQueue @ chunk-PJEEZAML.js?v=1fb14d92:7043
dispatchEventsForPlugins @ chunk-PJEEZAML.js?v=1fb14d92:7051
(anonymous) @ chunk-PJEEZAML.js?v=1fb14d92:7174
batchedUpdates$1 @ chunk-PJEEZAML.js?v=1fb14d92:18913
batchedUpdates @ chunk-PJEEZAML.js?v=1fb14d92:3579
dispatchEventForPluginEventSystem @ chunk-PJEEZAML.js?v=1fb14d92:7173
dispatchEventWithEnableCapturePhaseSelectiveHydrationWithoutDiscreteEventReplay @ chunk-PJEEZAML.js?v=1fb14d92:5478
dispatchEvent @ chunk-PJEEZAML.js?v=1fb14d92:5472
dispatchDiscreteEvent @ chunk-PJEEZAML.js?v=1fb14d92:5449Understand this error
useVisuraExtraction.ts:61 ‚ùå Backend extraction failed: TypeError: Failed to fetch
    at extractWithBackend (useVisuraExtraction.ts:40:30)
    at useVisuraExtraction.ts:191:24
    at useUpload.ts:70:33
    at Array.forEach (<anonymous>)
    at useUpload.ts:56:16
    at handleFileChange (ChatInputBar.tsx:36:5)
    at HTMLUnknownElement.callCallback2 (chunk-PJEEZAML.js?v=1fb14d92:3674:22)
    at Object.invokeGuardedCallbackDev (chunk-PJEEZAML.js?v=1fb14d92:3699:24)
    at invokeGuardedCallback (chunk-PJEEZAML.js?v=1fb14d92:3733:39)
    at invokeGuardedCallbackAndCatchFirstError (chunk-PJEEZAML.js?v=1fb14d92:3736:33)
extractWithBackend @ useVisuraExtraction.ts:61
await in extractWithBackend
(anonymous) @ useVisuraExtraction.ts:191
(anonymous) @ useUpload.ts:70
(anonymous) @ useUpload.ts:56
handleFileChange @ ChatInputBar.tsx:36
callCallback2 @ chunk-PJEEZAML.js?v=1fb14d92:3674
invokeGuardedCallbackDev @ chunk-PJEEZAML.js?v=1fb14d92:3699
invokeGuardedCallback @ chunk-PJEEZAML.js?v=1fb14d92:3733
invokeGuardedCallbackAndCatchFirstError @ chunk-PJEEZAML.js?v=1fb14d92:3736
executeDispatch @ chunk-PJEEZAML.js?v=1fb14d92:7014
processDispatchQueueItemsInOrder @ chunk-PJEEZAML.js?v=1fb14d92:7034
processDispatchQueue @ chunk-PJEEZAML.js?v=1fb14d92:7043
dispatchEventsForPlugins @ chunk-PJEEZAML.js?v=1fb14d92:7051
(anonymous) @ chunk-PJEEZAML.js?v=1fb14d92:7174
batchedUpdates$1 @ chunk-PJEEZAML.js?v=1fb14d92:18913
batchedUpdates @ chunk-PJEEZAML.js?v=1fb14d92:3579
dispatchEventForPluginEventSystem @ chunk-PJEEZAML.js?v=1fb14d92:7173
dispatchEventWithEnableCapturePhaseSelectiveHydrationWithoutDiscreteEventReplay @ chunk-PJEEZAML.js?v=1fb14d92:5478
dispatchEvent @ chunk-PJEEZAML.js?v=1fb14d92:5472
dispatchDiscreteEvent @ chunk-PJEEZAML.js?v=1fb14d92:5449Understand this error
useVisuraExtraction.ts:71 ü§ñ Tentativo 2: AI per estrazione visura...
useVisuraExtraction.ts:129 ‚úÖ AI extraction successful! {codici_ateco: Array(1), oggetto_sociale: "LA SOCIETA' HA PER OGGETTO LO SVILUPPO, LA PRODUZI‚Ä¶ VIGENTI NORME IN MATERIA DI ATTIVITA' RISERVATE.", sedi: {‚Ä¶}, tipo_business: 'B2B/B2C'}
2chunk-PJEEZAML.js?v=1fb14d92:521 Warning: Encountered two children with the same key, `2_2023-02-10 CELERYA VISURA ORD.pdf-1756503876147-131373`. Keys should be unique so that components maintain their identity across updates. Non-unique keys may cause children to be duplicated and/or omitted ‚Äî the behavior is unsupported and could change in a future version.
    at ul
    at div
    at div
    at UploadCenter (http://localhost:5173/src/components/sidebar/UploadCenter.tsx:26:44)
    at aside
    at Sidebar
    at div
    at main
    at div
    at App (http://localhost:5173/App.tsx:26:17)